name: ci-cd
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/txparser
  VM_HOST: 20.0.1.116
  VM_USER: azureuser
  LIVE_PORT: 8080

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run local integration tests (swapInfo non-zero)
        run: |
          chmod +x scripts/run-tests.sh
          ./scripts/run-tests.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push image (linux/amd64)
        run: |
          TAG=${GITHUB_SHA::12}
          docker buildx build --platform linux/amd64 \
            -t $IMAGE_NAME:$TAG \
            -t $IMAGE_NAME:latest \
            --push .

      - name: SaveTag
        id: meta
        run: echo "tag=${GITHUB_SHA::12}" >> $GITHUB_OUTPUT

  deploy:
    needs: test-build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: SSH deploy & smoke
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}  # your private key in repo secrets
          script_stop: true
          script: |
            set -e
            IMAGE="${{ env.IMAGE_NAME }}:${{ needs.test-build.outputs.tag }}"
            mkdir -p ~/txparser && cd ~/txparser

            # write/refresh scripts and tests on VM
            cat > deploy-simple.sh <<'EOS'
            $(sed 's/\\/\\\\/g' scripts/deploy-simple.sh)
            EOS
            cat > smoke.sh <<'EOS'
            $(sed 's/\\/\\\\/g' scripts/smoke.sh)
            EOS
            mkdir -p tests
            cat > tests/cases.json <<'EOS'
            $(sed 's/\\/\\\\/g' tests/cases.json)
            EOS
            chmod +x deploy-simple.sh smoke.sh

            ./deploy-simple.sh "$IMAGE" "${{ env.LIVE_PORT }}"
            ./smoke.sh 127.0.0.1 "${{ env.LIVE_PORT }}"

      - name: Public smoke (optional)
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl
          curl -sf http://${{ env.VM_HOST }}:${{ env.LIVE_PORT }}/healthz
          curl -s -X POST http://${{ env.VM_HOST }}:${{ env.LIVE_PORT }}/parse \
            -H 'Content-Type: application/json' \
            -d '{"signature":"2kAW5GAhPZjM3NoSrhJVHdEpwjmq9neWtckWnjopCfsmCGB27e3v2ZyMM79FdsL4VWGEtYSFi1sF1Zhs7bqdoaVT"}' \
            | jq -e 'has("transaction") and (.swapInfo != null)'
